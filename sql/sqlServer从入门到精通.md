# sqlserver 从入门到精通

## 第一篇、基础知识 （基础知识就是啰嗦一大堆 术语 读完根本 没懵逼也没记住什么）
### 较为有用的几个部分

1. <a href="#guanxishuyu">关系类型基本术语</a>
2. <a href="#shujukuguifan">数据库规范以及设计原则</a>
3. <a href="#chushihuaSQL">初始化SQL</a>

### 数据库系统的组成

* 数据
* 数据库管理系统
* 数据库管理员
* 支持数据库系统的硬件软件
* 用户

### 数据库的三级模式结构

#### 模式

    也叫 逻辑模式、概念模式，描述数据库的逻辑结构和特征，
    是 所有用户 的公共数据视图   
    一个数据库只有一个模式
    模式处于三级结构的中间层

#### 外模式

    也叫 用户模式、数据库用户的数据视图  
    外模式是模式的子集，一个数据库有多个外模式
    保障数据安全性的有利措施

#### 内模式

    也叫 存储模式 一个数据库只有一个内模式、他是 数据物理结构和存储方式的描述， 是数据库内部的表示方式

### 三级模式之间的两种映射

#### 外模式<->模式映射

    一个模式对应多个外模式
    相对于每一个外模式 都有一个  外模式<->模式映射

    当数据库 模式 改变时， 管理员可以通过更改多个  映射 
    来保证 外模式不变

    从而保证了数据与程序的逻辑独立性

#### 模式/内模式映射

    数据库只有一个模式和一个内模式，所以  模式<->内模式只有一个，

    当数据库的存储结构改变 通过更改映射   
    使模式保持不变、且应用程序也不用改变

    保证了 数据与程序的物理独立性

### 数据类型

* 数据结构： 是对系统静态特征的描述、 数据类型、内容、性质、数据间关系
* 数据操作： 对系统动态特征的描述、对数据库中各种对象实例的操作
* 完整性约束： 是完整规则的集合。定义了数据模型中所有数据及其联系所有的制约和依存规则

#### 常见的数据模型

* 常见的数据 模型有  层次模型、网状模型、关系模型

##### 层次模型

    用 树状图 表示 实体类型  以及 实体间的联系  的数据模型



##### 网状模型

    用 有向图 表示 实体类型 以及 实体键的联系 的数据类型

    复杂、独立性差
##### 关系模型
<div id="guanxishuyu">

    以 二维表 来描述数据。 关系模型中每个表有多个  字段列  和  记录行 每个字段有固定的属性

    主流的数据库数据模型

* 关系模型的基本术语

    关系： 一个二维表就是一个关系
    元组： 二维表中的一行，即表中的记录
    属性： 二维表中的一列，用类型和值表示
    域： 每个属性取值的变化范围

* 关系中的数据约束

    实体完整性约束： 约束关系的主键中属性值不能为空值
    参照完整性约束： 关系之间的基本约束
    用户定义的完整约束： 翻译了具体应用红数据的语义要求
##### 数据库规范化
<div id="shujukuguifan">

* 1NF ：在一个关系中，取消重复字段，个字段都是最小的逻辑存储单位
* 2NF ： 若关系模型 属于 1NF 则关系中每个 非主关键字段 都 依赖于主关键字段
* 3NF ： 若关系属于 1NF 是且关系中所有非主关键字段 都依赖于主关键字段，3NF要求去除传递依赖

##### 关系数据库的设计原则

* 数据库内数据文件的数据组织，应获得最大限度地共享、减小冗余度，消除数据及数据依赖关系中的冗余部分 使依赖于统一数据模型的数据达到有效的分离

* 保证输入、修改数据时数据的一致性与正确性

* 确保 数据 与 使用数据的应用程序 之间的高度独立



## 初始SQLserver
<div id="chushihuaSQL">


安装 -> 选择SQLserver独立安装添加功能

SQL server 功能安装 -> 下一步 -> 全选

匹配实例 -> 命名、选择根目录、  -> 下一步

数据库引擎配置  -> 下一步  -> 身份验证模式   设置密码

Peporting Services配置 -> 安装和配置 -> 下一步

分布式重播放控制器  -> 添加当前用户 -> 下一步

工作目录 与 结果目录 实例后面的文件夹  需要手动创建

----->  一路下一步  就安装完成了

## SQL Server 服务的启动与注册

### SQL server 的服务

    控制面板->系统和安全-> 管理工具 -> 服务

### 启动sqlserver服务

* 后台启动服务：控制面板->系统和安全-> 管理工具 -> 服务 -> sqlserver 2012 -> 启动

* SQLserver配置管理器启动 ： 

## 注册SQLserver 服务器

### 创建与删除服务器组

* 创建服务器组 ： 使用 ssms - 取消  - 视图 - 已注册的服务器 - 本地服务器组 右键 新建服务器组/删除服务器组


### 注册与删除服务器

* 使用 ssms - 取消  - 视图 - 已注册的服务器 - 本地服务器组 - 某个本地服务器组 右键 新建服务器注册   删除 直接右键实例即可

## 认识数据库

### 数据库的基本概念

* 数据库常用对象

    1. 表： （表）包含数据库所有数据的数据库对象 由行和列组成
    2. 字段： （列）表中每列 成为一个字段
    3. 索引： （列名）索引是一个单独的、物理的数据库结构、她一来与表建立，在数据库中索引使数据库程序 无需对 整个表进行扫描就能找到所需的数据
    4. 视图：（search产生的表） 是从一张或多张表中导出的表  也称  虚拟表，是用户查看数据表中数据的唯一方式，表中包括几个被定义的数据列与数据行，其结构和数据床架在对表的查询基础之上
    5. 存储过程：（sql语句） 是一组为了完成特定功能的SQL 语句集合 经编译后以名称的形式存储在QSLserver 数据库都得数据

* 数据库的组成

    数据库是由文件和文件组组成。数据库中所有的数据和对象都存储在文件中

    1. 文件

        * 主要数据文件

            存放 数据和数据库初始化信息、每个数据库只有一个主要数据文件，默认拓展名  .mdf

        * 次要数据文件

            其余的文件 且有多个  .ndf

        * 日志文件

            .ldf
    2. 文件组

        * 主文件组： 包含主要数据和任何没有明确指派给其他文件组的文件。系统表的所有页都分配在主文件组中

        * 用户定义文件组：主要的在CREATE DATABASE ALTER 语句中使用 FILEGROUP关键字指定文件组
* 系统数据库

    1. master： 记录实例的所有系统级信息，包括 元数据、断电、连接服务器、系统配置设置
    2. tempdb： 临时数据库、保存临时对象或 中间结果集
    3. model：  数据库的模板
    4. msdb：   代理计划警报和工作
* 标识符 命名规则

    1. 标识符首字母
        包含 字母 _ # @ 

        @ 表示局部变量或参数 @gzd
        \# 表示临时表    #gzd
        \#\# 全局临时表   ##gzd  

        Transact-SQL函数名以 @@ 开始故  避免使用

    2. 标识符其他位置

        @ $ # _

    3. 标识符不允许是 transact-SQL的保留字

    4. 允许包含空格或其他特殊字符 最好全大写

* 标识符分类

    常规标识符： 符合格式的表示服
    分隔标识符： 包括在 双引号() 或 方括号[]内的标识符。标识符可以不符合格式规则   切 在1~128 位之间   

* 对象命名规则(数据库)

    服务器、数据库名、拥有者名、对象名

### 数据库的创建与管理

    使用 ssms 新建数据库
    右击属性 - 数据库属性 - 所有者 - 浏览 - 完成数据库所有者更改操作

    删除数据库 有击数据库  删除数据库

### 基本数据类型


#### 1.Character 字符串

数据类型 | 描述
-|-
char(n) |固定长度的字符串，最多8000个字符
varchar(n) | 可变长度字符串最多8000个字符
varvhar(max) | 可变长字符串最多1073741824个字符
text | 可变长字符串，最多2GB字符数据

#### 2.Unicode字符串

数据类型|描述
-|-
nchar(n) | 固定的Unicode数据最多4000字符
<b style="background:green">nvarchar(n)</b> | 可变长Uincode数据最多4000字符
nvarchar(max) | 可变长的Unicode数据最多53680912个字符
ntext | 可变长的Unicode数据 最多2GB字符数据

#### 3. Number类型

数据类型 | 描述 | 存储
-|-|-
tinyint | 0 ~ 255 | 1字节
smallint | -32768 ~ 32767 | 2字节
int | -2147483648 ~ 2147483648	2开头 10位数 | 4字节
bigint | -9223372036854775808~9223372036854775808(18位) | 8字节
decimal(p,s) | 固定精度和比例的数字 允许 -10^38+1 ~ 10^38-1 <br>p参数指小数点 左侧加右侧最大位数（最大38默认18）<br>s指 小数点右侧最大位数（默认0）|5-17字节
numeric(p,s) | 同上 decimal(p,s) | 5~17字节
smallmoney | -214748.3648 ~ 214748.3647 之间的货币数据 | 4字节
money | -922337203685477.5808~922337203685477.5807货币 |8字节
float(n) | -1.79E+308~1.79E+308的浮动精度数字数据<br>为 24或53分别表示存储4或8字节 | 4/8字节
real | -3.4E+38~3.4E+38的浮动精度数字数据|4字节

#### 4. Date类型

数据类型 | 描述 | 存储
-|-|-
datatime | 1753/1/1~9999/12/30 精度33毫秒 | 8字节
datatime2 | 1753/1/1~9999/12/30 精度 100纳秒 |6-8字节
smalldatetime | 1900/1/1~2079/6/6 精度1分钟 | 4字节
date | 仅存储日期 0001/1/1~9999/12/31 | 3字节
time | 仅存储时间 精度为 100纳秒 | 3-5字节
datetimeoffset |与datetime2相同外加时区偏移 | 8-10字节
timestamp | 内部时钟

#### 5.Binary（二进制）类型

数据类型 | 描述
-|-
bit|0、1、null
binary(n) | 固定长度二进制最多8000字符
varbinary | 可变长度二进制数据最多8000字节
varbinary(max) | 可变长度的二进制数据最多 2gb
image | 可变长度的二进制数据最多2gb


#### 新建自定义数据类型

    数据库 - 可编程性 - 类型 右击 新建用户数据类型

### 其他的机制

1. 空值与非空值

2. 默认值

3. 特定标识符

    标识符唯一 常被定义为主键   空值与标识标识不能同时存在于一个数据

4. 约束

    * 非空
    * 检查： 指定布尔操作、限制输入到表的值
    * 唯一性： 唯一不能重复  但可为空
    * 主键： 建立一列或多列的组合，以唯一标识表中的一行。主键可以保证实体完整性，一个表只能有一个主键，同时主键不能为空
    * 外键： 连接两张表的  一列或多列 
    主键的一列被添加到另一个表中时  连接就建立了、主要目的空值存储在外键表中的数据

### 新建表 设计表

    通过 ssms  数据库 - 表 - 右键新建表 设置名字
    右键新建的表 设计

## 第二篇、核心技术

### SQL基础

#### T-SQL的组成

    基本所有的关系型数据库都支持 标准的 SQL语句，
     但是 T-SQL是 sqlserver 独有的   是sql加强版

* 数据定义语言
* 数据控制语言
* 数据操作语言

##### T-SQL语句结构

每条SQL语句都以 谓词开始

* SQLECT 子句
* FROM 子句
* \[INTO子句\]
* \[WHERE 子句\]
* \[GROUP BY 子句\]
* \[HAVING 子句\]
* \[ORDER BY 子句\]

#### 常量

    数字、 字符串 、日期
    符号常量  CURRENT_DATE CURRENT_TIME CURRENT_STAMP等

#### 变量

SQL也有 局部变量、全局变量

* 局部变量

    * 声明

    局部变量：  必须以  @变量名 变量类型 的格式
    ，多个变量的时候用，隔开

    ```sql
        declare @song char(10)
    ```

    * 赋值

    使用 SELECT 赋值
    
    简单赋值

    ```sql
        DECLARE @song char(20)
        SET @song = 'That Girl'
    ```
    给多个变量赋值

    ```sql
        declare @b int, @c char(10), @a int
        select @b=1, @c=love, @a=2
    ```
* 全局变量

    以@@开头

    * @@CONNECTIONS : 最后一次启动以来 所有的连接次数 包括失败的次数
    * @@CPU_BUSY : 记录自上次启动以来尝试的连接次数、包括失败 以ms为单位的cpu工作时间
    * @@CURSOR_ROWS: 返回本次服务器连接中  打开游标去除的  行数
    * @@DBTS: 返回当前数据库中timestamp数据类型的当前值
    * @@ERROR: 返回 上一条执行的 报错代码
    * @@FETCH_STATUS: 返回上一次使用游标FETCH所返回的状态值、切返回类型
        0 ： 成功
        -1：语句失败或慈航不在结果集中
        -2：被提取的行不存在
    * @@IDENTITY： 返回最近一次插入identity列的数值

。。。。  **也是够了  者破书看的好闹听**


#### 注释符、运算符与通配符

##### 注释

```sql
    -- 单行注释

    /*
    *   多行注释
    */
```

##### 运算符

1. 算数运算符： 加、减、乘、除、取余（与js相同）

2. 赋值运算符 =

3. 比较运算符 可以比较除 text、ntext、image 以外所有数据类型
    
     ```
    >  (大于)
    <  (小于)
    =  (等于)
    >= (大于等于)
    <= (小于等于)
    <>(不等于)
    !=  (不等于)
    !>  (不大于)
    !<  (不小于)
    ```
4. 逻辑运算符

    运算符|行为
    -|-
    all | 比较集中都为true 返回true
    ANY | 比较集中有任意true 返回true
    BETWEEN | 范围之间则true
    EXUSTS  | 如果 子查询 包含任何行则值为true
    IN  | 如果 操作数 与一个表达式列表中的某个相等则为true
    LIKE| 如果 有模式匹配的返回true
    AND | 两边 逻辑与 判断
    OR  | 两边 逻辑或 判断
    NOT | 逻辑非

5. 位运算符

    运算符|说明
    -|-
    @   |   按位与
    ^   |   按位互斥
    \|  |   按位或
    ~   |   按位非

6. 字符串连接符 +

    连接两个字符串、或者两边都可一转换成数字、否则报错

7. 算数优先级

    ```
    （1）＋（正）、−（负）、～（位反）
    （2）*（乘）、/（除）、％（取余）
    （3）＋（加）、＋（字符串串联运算符）、-（减）
    （4）=、>、<、>、=、<、=、<、>、！、=、！、>、！、<（比较运算符）
    （5）^（按位异或）、&（按位与）、|（按位或）
    （6）NOT
    （7）AND
    （8）ALL ANY BETWEEN IN LIKE OR SOME（逻辑运算符）
    （9）=（赋值）
```
8. 通配符

    通配符|描述|实例
    -|-|-
    %   |   包含0个或更多的任意覅付 |l% 可以匹配 love 、life等等
    _   |   任何单个字符    | li_e可以匹配 like life、不能匹配 likke等
    []  |   匹配范围内的任意单个字符    | [0~2]123 可以匹配 0123、1123、2123
    [^] |   匹配不属于范围的任意单个字符| [^0~9]123 匹配不以 数字开头，以123结尾的


#### 流程控制

1. BEGIN...END

用于将多个T-SQL语句合为一个逻辑块,空值流程中多条语句的时候就 需要被包在 里面

```sql
    DECLARE @x int, @y int, @z int 
    set @x = 1
    set @y =2
    BEGIN
        set @z = @x
        set @x = @y
        set @y = @z
    END
    PRINT @x
    PRINT @Y
```

2. IF

判断语句
```sql
    declare @x int
    set @x = 1
    if @x > 0
    print '@x 是正数'
```

3. IF ELSE

判断语句  嵌套使用解决复杂判断
```sql
    declare @x int
    set @x = -1 
    if @x > 0
        print '@x是正数'
    else
        print '@x是负数'
```

4. CASE

使用CASE 

查询 表 根据 分数判断 

原表

![](http://96weibin-blog.oss-cn-beijing.aliyuncs.com/18-11-1/28696745.jpg)

```sql
use DEVELOPMENT
select * ,
备注 = case
when grade >= 90 then '优秀'
when grade >= 70 and grade < 90 then '良好'
when grade >= 60 and grade < 70 then '及格'
else '不及格'
end
from student
```
执行上面代码后

![](http://96weibin-blog.oss-cn-beijing.aliyuncs.com/18-11-1/68312537.jpg)

但是这并不会影响到 原来的表  重新查看原来的表  

5. WHILE

```sql
declare @i int, @sum int
select @i = 0, @sum = 0
while @i < 10
begin 
	set @sum = @i + @sum
	set @i = @i + 1
end
print @sum
```

6. WHILE...CONTINUE/BREAK

```sql
declare @i int--定义
set @i = 0  --赋值
while @i < 10   --while true
begin
	if @i % 2 = 0
		begin --两行就需要begin end
			print @i
			set @i = @i +1
		end
	else
		begin

			set @i = @i + 1
			continue
		end
end
```

7. RETURN

结束程序 之后的不会执行 可以设置返回值  未设置则返回 状态值
![](http://96weibin-blog.oss-cn-beijing.aliyuncs.com/18-11-1/54883716.jpg)

```sql
print '世界这美好'
return 
print '你说的对'
```
只输出 '世界真美好'

8. GOTO

跳到执行 指定行、或标识符

标识符 如 'tar: '要以 冒号 结尾

```sql
declare @i int, @sum int
select @i = 0, @sum = 0
tar: --目标
set @sum = @i + @sum
set @i = @i + 1
if @i < 10 
begin
	print @i
	goto tar --跳转
end
print @sum
```

9. WAITFOR

程序延迟执行

```sql
waitfor delay '00:00:05' --延迟5秒
print 'hello'
```

#### 常用命令

##### DBCC (dataBase base consistency checker) 

用于验证数据库完整性、查找错误、分析系统使用等
1. DBCC CHECKALLOC

    查看数据库的磁盘空间分配结构的一致性

2. DBCC SHOWCONTIG

    显示指定表的数据和索引的碎片信息

3. CHECKPOINT
检查当前工作的数据库中被更改过的数据页或日志页，并将这些数据从数据缓冲器中强制写入硬盘。

```sql
Use db_2012
CHECKPOINT
```

4. PRINT 

项客户端返回一个 用户自定义的字符串 （最长255）

5. RAISERROR

在sql 系统中返回错误信息是同时返回用户的指令信息

6. READTEXT

读取 text、ntext、image中的值

7. BACKUP

    将数据库内容 或 日志 备份到存储介质上

    ```sql
    backup DATABASE development to disk='backup.bak'
    ```
    文件在 sqlserver root/**/ Backup 里

8. RESTORE

将数据库或事务处理日志备份文件 由存储介质还原到 sqlserver

9. SELECT

除了用于查询、可以用于赋值 可以同时赋值多个

```sql
declare @a int, @b int, @c int
select @a = 1, @b = 2, @c = 3
print @a
print @b
print @c
```
10. SET

* 用于给局部变量赋值  才declare的是null

* 处理选项预定

如果要给计算列或索引视图创建操作索引，

不知道你在说啥呢

    则必须将SET选项ARITHABORT、CONCAT_NULL_YIELDS_NULL、QUOTED_IDENTIFIER、ANSI_NULLS、ANSI_PADDING和ANSI_WARNINGS设置为ON，并将选项NUMERIC_ROUNDABORT设置为OFF。


11. SHUTDOWN

立即停止sqlserver的执行

```sql
SHUTDOWN[WITH NOWAIT]
```
执行的顺序

1. 种植任何用户登录
2. 等待尚未完成的sql或存储过程完毕
3. 在每一个数据库中执行 CHECKPOINT命令
4. 停止SQLServer的服务（停止服务  还要手动开启）

12. WRITETEXT

为 text、ntext、image进行交互式更新
不能用在 视图中的text 、 ntext 和 image上

13. USE

命令用于在工作区开启 或关闭数据库


### SQL函数的使用

#### 聚合函数

### SQL查询基础

### SQl查询高级

### 视图的使用

1. 创建视图

    选择要操作的数据库，右击其内部的视图 ， 新建视图
    勾选 要查询的列的  ctrl + r 执行 ctrl + s 保存视图

    sql视图先看到这里  等回去再看

2. 删除视图





















